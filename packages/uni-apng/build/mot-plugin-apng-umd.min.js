!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self)["mot-plugin-apng"]=e()}(this,(function(){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])})(e,r)};function e(t,e,r,n){return new(r||(r=Promise))((function(o,a){function i(t){try{h(n.next(t))}catch(t){a(t)}}function s(t){try{h(n.throw(t))}catch(t){a(t)}}function h(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(i,s)}h((n=n.apply(t,e||[])).next())}))}function r(t,e){var r,n,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,n=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=e.call(t,i)}catch(t){a=[6,t],n=0}finally{r=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}for(var n=function(t,e,r){var n="vs"==e?t.createShader(t.VERTEX_SHADER):t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(n,r),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw t.deleteShader(n),new Error("An error occurred compiling the shaders: "+t.getShaderInfoLog(n));return n},o=function(t,e,r,o,a,i){var s=function(t,e,r){var o=n(t,"vs",e),a=n(t,"fs",r),i=t.createProgram();if(t.attachShader(i,o),t.attachShader(i,a),t.linkProgram(i),!t.getProgramParameter(i,t.LINK_STATUS))throw new Error("Unable to initialize the shader program: "+t.getProgramInfoLog(i));return t.useProgram(i),i}(t,"\n    attribute vec2 a_position;\n    attribute vec2 a_texCoord;\n    uniform vec2 u_resolution;\n    varying vec2 v_texCoord;\n    void main() {\n        vec2 zeroToOne = a_position / u_resolution;\n        vec2 zeroToTwo = zeroToOne * 2.0;\n        vec2 clipSpace = zeroToTwo - 1.0;\n        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);\n        v_texCoord = a_texCoord;\n    }\n","\n    precision mediump float;\n    uniform sampler2D u_image;\n    varying vec2 v_texCoord;\n    void main() {\n        gl_FragColor = texture2D(u_image, v_texCoord);\n    }\n"),h=t.getAttribLocation(s,"a_position"),u=t.getAttribLocation(s,"a_texCoord"),c=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,c),function(t,e,r,n,o){var a=e,i=e+n,s=r,h=r+o;t.bufferData(t.ARRAY_BUFFER,new Float32Array([a,s,i,s,a,h,a,h,i,s,i,h]),t.STATIC_DRAW)}(t,a,i,e.width,e.height);var p=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,p),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW);var l=t.createTexture();t.bindTexture(t.TEXTURE_2D,l),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e);var f=t.getUniformLocation(s,"u_resolution");t.viewport(0,0,r,o),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT),t.useProgram(s),t.enableVertexAttribArray(h),t.bindBuffer(t.ARRAY_BUFFER,c);var d=2,m=t.FLOAT,A=!1,y=0,g=0;t.vertexAttribPointer(h,d,m,A,y,g),t.enableVertexAttribArray(u),t.bindBuffer(t.ARRAY_BUFFER,p);d=2,m=t.FLOAT,A=!1,y=0,g=0;t.vertexAttribPointer(u,d,m,A,y,g),t.uniform2f(f,t.canvas.width,t.canvas.height);var v=t.TRIANGLES;g=0;t.drawArrays(v,g,6)},a=function(){function t(){this.hookmap={stop:[],allStop:function(){}},this.onceHookMap={stop:[],allStop:function(){}},this.width=0,this.height=0,this.numPlays=0,this.actualPlays=0,this.playTime=0,this.frames=[],this.rate=1,this.nextRenderTime=0,this.fNum=0,this.prevF=null,this.played=!1,this.finished=!1,this.contexts=[],this.contextsBackup=[],this.endFrame=-1,this.startFrame=0,this.beforeHook=void 0,this.afterHook=void 0,this.pauseNum=0,this.manualEndNum=-1,this.manualPlayNum=0,this.keep=!1}return t.prototype.play=function(t){var e=this;void 0===t&&(t=[]),this.played||this.finished||(this.rewind(),this.setFrameNum(t),this.played=!0,requestAnimationFrame((function(t){e.tick(t)})))},t.prototype.stop=function(){this.contextsBackup=this.contexts.map((function(t){return t})),!1===this.keep&&(this.contexts=[]),this.rewind(),this.onceHookMap.allStop(),this.onceHookMap.allStop=function(){},this.onceHookMap.stop.forEach((function(t){t()})),this.onceHookMap.stop=[],this.hookmap.allStop(),this.hookmap.stop.forEach((function(t){t()}))},t.prototype.pause=function(t){null==t?(this.pauseNum=this.fNum,this.stop(),this.contexts=this.contextsBackup):this.manualEndNum=t},t.prototype.start=function(t){var e=this;this.fNum=this.pauseNum,null!=t&&(this.fNum=t),this.played=!0,requestAnimationFrame((function(t){e.tick(t)}))},t.prototype.clear=function(){var t=this;this.isWebGL?this.contextsBackup.forEach((function(t){t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT)})):this.contextsBackup.forEach((function(e){e.clearRect(0,0,t.width,t.height)}))},t.prototype.before=function(t){this.beforeHook=t||null},t.prototype.after=function(t){this.afterHook=t||null},t.prototype.on=function(t,e){if(null!=e)switch(t){case"stop":this.hookmap.stop.push(e);break;case"allStop":this.hookmap.allStop=e}},t.prototype.once=function(t,e){if(null!=e)switch(t){case"stop":this.onceHookMap.stop.push(e);break;case"allStop":this.onceHookMap.allStop=e}},t.prototype.rewind=function(){this.nextRenderTime=0,this.fNum=0,this.actualPlays=0,this.prevF=null,this.played=!1,this.finished=!1},t.prototype.setFrameNum=function(t){0!==t.length&&(this.startFrame=t[0],this.fNum=this.startFrame,t.length>1&&(this.endFrame=t[1]))},t.prototype.setOptions=function(t){void 0!==t.rate&&(this.rate=t.rate<=0?1:t.rate),void 0!==t.playNum&&(this.manualPlayNum=t.playNum<0?0:t.playNum),void 0!==t.keep&&(this.keep=t.keep)},t.prototype.addContext=function(t){this.contexts.length>0&&(this.isWebGL||(t._apng_animation=this)),this.contexts.push(t)},t.prototype.removeContext=function(t){var e=this.contexts.indexOf(t);-1!==e&&(this.contexts.splice(e,1),0===this.contexts.length&&this.rewind(),"_apng_animation"in t&&delete t._apng_animation)},t.prototype.tick=function(t){for(var e=this;this.played&&this.nextRenderTime<=t;)this.renderFrame(t);this.played&&requestAnimationFrame((function(t){e.tick(t)}))},t.prototype.renderFrame=function(t){var e=this,r=this.fNum;if(-1!==this.manualEndNum&&r==this.manualEndNum)return this.manualEndNum=-1,void this.pause();this.fNum++,(this.fNum>=this.frames.length||this.fNum>this.endFrame&&-1!=this.endFrame)&&(this.fNum=this.startFrame,this.actualPlays++);var n=this.frames[r];if(0!=this.manualPlayNum&&this.actualPlays>=this.manualPlayNum)this.stop();else{for(0==r&&(this.isWebGL?this.contexts.forEach((function(t){t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT)})):this.contexts.forEach((function(t){t.clearRect(0,0,e.width,e.height)})),this.prevF=null,2==n.disposeOp&&(n.disposeOp=1)),this.prevF&&1==this.prevF.disposeOp?this.isWebGL?this.contexts.forEach((function(t){})):this.contexts.forEach((function(t){t.clearRect(e.prevF.left,e.prevF.top,e.prevF.width,e.prevF.height)})):this.prevF&&2==this.prevF.disposeOp&&(this.isWebGL?this.contexts.forEach((function(t){})):this.contexts.forEach((function(t){t.putImageData(e.prevF.iData,e.prevF.left,e.prevF.top)}))),this.prevF=n,this.prevF.iData=null,2==this.prevF.disposeOp&&(this.isWebGL||(this.prevF.iData=this.contexts[0].getImageData(n.left,n.top,n.width,n.height))),0==n.blendOp&&(this.isWebGL?this.contexts.forEach((function(t){t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT)})):this.contexts.forEach((function(t){t.clearRect(n.left,n.top,n.width,n.height)}))),this.isWebGL?this.contexts.forEach((function(t){o(t,n.img,e.width,e.height,n.left,n.top)})):this.contexts.forEach((function(t){null==e.beforeHook&&null==e.afterHook||t.clearRect(0,0,e.width,e.height),e.beforeHook&&e.beforeHook(t,r),t.drawImage(n.img,n.left,n.top),e.afterHook&&e.afterHook(t,r)})),0==this.nextRenderTime&&(this.nextRenderTime=t);t>this.nextRenderTime+this.playTime;)this.nextRenderTime+=this.playTime;this.nextRenderTime+=n.delay/this.rate}},t}(),i=new Uint32Array(256),s=0;s<256;s++){for(var h=s,u=0;u<8;u++)h=1&h?3988292384^h>>>1:h>>>1;i[s]=h}var c=function(){function t(){}return t.prototype.loadUrl=function(t){return new Promise((function(e,r){var n=new XMLHttpRequest;n.open("GET",t),n.responseType="arraybuffer",n.onload=function(){200==this.status?e(this.response):r(this)},n.send()}))},t}(),p=new Uint8Array([137,80,78,71,13,10,26,10]),l=new(function(n){function o(){var t=null!==n&&n.apply(this,arguments)||this;return t.urlBuffer={},t.url2Promise={},t}return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}(o,n),o.prototype.urlParse=function(t,n){return void 0===n&&(n=!1),e(this,void 0,void 0,(function(){var e=this;return r(this,(function(r){return void 0===this.urlBuffer[t]&&(this.urlBuffer[t]=this.loadUrl(t),this.url2Promise[t]=this.urlBuffer[t].then((function(t){return e.parse(t.slice(0))}))),n?[2,this.urlBuffer[t].then((function(t){return e.parse(t.slice(0))}))]:[2,this.url2Promise[t]]}))}))},o.prototype.checkPngSignature=function(t){for(var e=0;e<p.length;e++)if(p[e]!=t[e])return!1;return!0},o.prototype.createImages=function(t,e,r,n,o,a){for(var i=0,s=new Blob(r),h=new Blob(n),u=0;u<t.frames.length;u++){var c=t.frames[u],l=[];l.push(p),e.set(this.makeDWordArray(c.width),0),e.set(this.makeDWordArray(c.height),4),l.push(this.makeChunkBytes("IHDR",e)),l.push(s);for(var f=0;f<c.dataParts.length;f++)l.push(this.makeChunkBytes("IDAT",c.dataParts[f]));l.push(h);var d=URL.createObjectURL(new Blob(l,{type:"image/png"}));delete c.dataParts,l=null,c.img=document.createElement("img"),c.img.onload=function(){URL.revokeObjectURL(this.src),++i==t.frames.length&&o(t)},c.img.onerror=function(){a("Image creation error")},c.img.src=d}},o.prototype.parse=function(t){var e=this,r=new Uint8Array(t);return new Promise((function(t,n){e.checkPngSignature(r)||(console.error("Not a PNG file (invalid file signature)"),n("Not a PNG file (invalid file signature)"));var o=e.parseChunks(r),a=o.preDataParts,i=o.postDataParts,s=o.headerDataBytes,h=o.anim;if(0==h.frames.length)return console.error("Not an animated PNG"),void n("Not an animated PNG");e.createImages(h,s,a,i,(function(e){t(e)}),(function(t){console.error(t),n(t)}))}))},o.prototype.parseChunks=function(t){var e,r,n=[],o=[],i=null,s=null,h=new a,u=8;do{switch(e=this.readDWord(t,u),r=this.readString(t,u+4,4)){case"IHDR":i=t.subarray(u+8,u+8+e),h.width=this.readDWord(t,u+8),h.height=this.readDWord(t,u+12);break;case"acTL":h.numPlays=this.readDWord(t,u+8+4);break;case"fcTL":s&&h.frames.push(s),(s={}).width=this.readDWord(t,u+8+4),s.height=this.readDWord(t,u+8+8),s.left=this.readDWord(t,u+8+12),s.top=this.readDWord(t,u+8+16);var c=this.readWord(t,u+8+20),p=this.readWord(t,u+8+22);0==p&&(p=100),s.delay=1e3*c/p,s.delay<=10&&(s.delay=100),h.playTime+=s.delay,s.disposeOp=this.readByte(t,u+8+24),s.blendOp=this.readByte(t,u+8+25),s.dataParts=[];break;case"fdAT":s&&s.dataParts.push(t.subarray(u+8+4,u+8+e));break;case"IDAT":s&&s.dataParts.push(t.subarray(u+8,u+8+e));break;case"IEND":o.push(this.subBuffer(t,u,12+e));break;default:n.push(this.subBuffer(t,u,12+e))}u+=12+e}while("IEND"!=r&&u<t.length);return s&&h.frames.push(s),{preDataParts:n,postDataParts:o,headerDataBytes:i,frame:s,anim:h}},o.prototype.readWord=function(t,e){for(var r=0,n=0;n<2;n++)r+=t[n+e]<<8*(1-n);return r},o.prototype.readDWord=function(t,e){var r=0;r+=t[0+e]<<24>>>0;for(var n=1;n<4;n++)r+=t[n+e]<<8*(3-n);return r},o.prototype.readByte=function(t,e){return t[e]},o.prototype.subBuffer=function(t,e,r){var n=new Uint8Array(r);return n.set(t.subarray(e,e+r)),n},o.prototype.readString=function(t,e,r){var n=Array.prototype.slice.call(t.subarray(e,e+r));return String.fromCharCode.apply(String,n)},o.prototype.makeDWordArray=function(t){return[t>>>24&255,t>>>16&255,t>>>8&255,255&t]},o.prototype.makeStringArray=function(t){for(var e=[],r=0;r<t.length;r++)e.push(t.charCodeAt(r));return e},o.prototype.makeChunkBytes=function(t,e){var r=t.length+e.length,n=new Uint8Array(new ArrayBuffer(r+8));n.set(this.makeDWordArray(e.length),0),n.set(this.makeStringArray(t),4),n.set(e,8);var o=function(t,e,r){for(var n=-1,o=e=e||0,a=e+(r=r||t.length-e);o<a;o++)n=n>>>8^i[255&(n^t[o])];return-1^n}(n,4,r);return n.set(this.makeDWordArray(o),r+4),n},o}(c));return function(){function t(){}return t.prototype.checkNativeFeatures=function(){return new Promise((function(t){var e=document.createElement("canvas"),r={TypedArrays:"ArrayBuffer"in global,BlobURLs:"URL"in global,requestAnimationFrame:"requestAnimationFrame"in global,pageProtocol:"http:"==location.protocol||"https:"==location.protocol,canvas:"getContext"in document.createElement("canvas"),APNG:!1};if(r.canvas){var n=new Image;n.onload=function(){var o=e.getContext("2d");o.drawImage(n,0,0),r.APNG=0===o.getImageData(0,0,1,1).data[3],t(r)},n.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACGFjVEwAAAABAAAAAcMq2TYAAAANSURBVAiZY2BgYPgPAAEEAQB9ssjfAAAAGmZjVEwAAAAAAAAAAQAAAAEAAAAAAAAAAAD6A+gBAbNU+2sAAAARZmRBVAAAAAEImWNgYGBgAAAABQAB6MzFdgAAAABJRU5ErkJggg=="}else t(r)}))},t.prototype.isSupport=function(t){return void 0===t&&(t=!1),this.checkNativeFeatures().then((function(e){return e.APNG&&!t?Promise.reject(!1):Promise.resolve(!0)}))},t.prototype.parseBuffer=function(t){return l.parse(t)},t.prototype.parseURL=function(t,e){return l.urlParse(t,e)},t.prototype.animateImage=function(t,e,r,n){var o=this;void 0===e&&(e=!0),void 0===r&&(r=!1),void 0===n&&(n="auto"),t.setAttribute("data-is-apng","progress");return new Promise((function(a,i){o.parseURL(t.src,r).then((function(r){!function(r){t.setAttribute("data-is-apng","yes"),"0"===t.style.opacity&&(t.style.opacity="1");var o=document.createElement("canvas");o.width=r.width,o.height=r.height,Array.prototype.slice.call(t.attributes).forEach((function(t){-1==["alt","src","usemap","ismap","data-is-apng","width","height"].indexOf(t.nodeName)&&o.setAttributeNode(t.cloneNode(!1))})),o.setAttribute("data-apng-src",t.src),""!=t.alt&&o.appendChild(document.createTextNode(t.alt));var a,i="",s="",h=0,u="";""!=t.style.width&&"auto"!=t.style.width?i=t.style.width:t.hasAttribute("width")&&(i=t.getAttribute("width")+"px"),""!=t.style.height&&"auto"!=t.style.height?s=t.style.height:t.hasAttribute("height")&&(s=t.getAttribute("height")+"px"),""!=i&&""==s&&(h=parseFloat(i),u=i.match(/\D+$/)[0],s=Math.round(o.height*h/o.width)+u),""!=s&&""==i&&(h=parseFloat(s),u=s.match(/\D+$/)[0],i=Math.round(o.width*h/o.height)+u),o.style.width=i,o.style.height=s,t.parentNode.insertBefore(o,t),t.parentElement.removeChild(t),"auto"===n?a=!0:"2d"===n?a=!1:"webgl"===n&&(a=!0),"auto"===n&&(document.createElement("canvas").getContext("webgl")||(console.warn("无法初始化WebGL，你的浏览器、操作系统或硬件等可能不支持WebGL,切换到canvas2d"),a=!1)),r.isWebGL=a,r.addContext(a?o.getContext("webgl"):o.getContext("2d")),!0===e&&r.play()}(r),a(r)})).catch((function(e){t.setAttribute("data-is-apng","no"),i(e)}))}))},t.prototype.bindCanvas=function(t,e){},t.prototype.ifHasCache=function(t){var e=this;return new Promise((function(r,n){e.emit("getCache",t),e.on("getCacheBack",(function(t){null==t?n(!1):r(t)}))}))},t.install=function(e){e.register("APNG",(function(){var r=new t;return r.on=e.on,r.emit=e.emit,r.canYouUseCache=e.plugins.LocalCache&&e.plugins.LocalCache.installed,r}))},t.installed=!1,t.pluginName="APNG",t}()}));
