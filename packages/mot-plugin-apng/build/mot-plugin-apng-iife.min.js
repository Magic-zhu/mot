!function(){"use strict";class t{constructor(){this.hookmap={stop:[]},this.onceHookMap={stop:[]},this.width=0,this.height=0,this.numPlays=0,this.actualPlays=0,this.playTime=0,this.frames=[],this.rate=1,this.nextRenderTime=0,this.fNum=0,this.prevF=null,this.played=!1,this.finished=!1,this.contexts=[],this.contextsBackup=[],this.endFrame=-1,this.startFrame=0,this.beforeHook=void 0,this.afterHook=void 0,this.pauseNum=0,this.manualEndNum=-1,this.manualPlayNum=0}play(t=[]){this.played||this.finished||(this.rewind(),this.setFrameNum(t),this.played=!0,requestAnimationFrame((t=>{this.tick(t)})))}stop(){this.contextsBackup=this.contexts.map((t=>t)),this.contexts=[],this.rewind(),this.onceHookMap.stop.forEach((t=>{t()})),this.onceHookMap.stop=[],this.hookmap.stop.forEach((t=>{t()}))}pause(t){null==t?(this.pauseNum=this.fNum,this.stop()):this.manualEndNum=t}start(t){this.fNum=this.pauseNum,null!=t&&(this.fNum=t),this.played=!0,requestAnimationFrame((t=>{this.tick(t)}))}clear(){this.contextsBackup.forEach((t=>{t.clearRect(0,0,this.width,this.height)}))}before(t){this.beforeHook=t||null}after(t){this.afterHook=t||null}on(t,e){if(null!=e)switch(t){case"stop":this.hookmap.stop.push(e)}}once(t,e){if(null!=e)switch(t){case"stop":this.onceHookMap.stop.push(e)}}rewind(){this.nextRenderTime=0,this.fNum=0,this.actualPlays=0,this.prevF=null,this.played=!1,this.finished=!1}setFrameNum(t){0!==t.length&&(this.startFrame=t[0],this.fNum=this.startFrame,t.length>1&&(this.endFrame=t[1]))}setOptions(t){void 0!==t.rate&&(this.rate=t.rate<=0?1:t.rate),void 0!==t.playNum&&(this.manualPlayNum=t.playNum<0?0:t.playNum)}addContext(t){if(this.contexts.length>0){let e=this.contexts[0].getImageData(0,0,this.width,this.height);t.putImageData(e,0,0)}this.contexts.push(t),t._apng_animation=this}removeContext(t){let e=this.contexts.indexOf(t);-1!==e&&(this.contexts.splice(e,1),0===this.contexts.length&&this.rewind(),"_apng_animation"in t&&delete t._apng_animation)}tick(t){for(;this.played&&this.nextRenderTime<=t;)this.renderFrame(t);this.played&&requestAnimationFrame((t=>{this.tick(t)}))}renderFrame(t){let e=this.fNum;if(-1!==this.manualEndNum&&e==this.manualEndNum)return this.manualEndNum=-1,void this.pause();this.fNum++,(this.fNum>=this.frames.length||this.fNum>this.endFrame&&-1!=this.endFrame)&&(this.fNum=this.startFrame,this.actualPlays++);let s=this.frames[e];if(0!=this.manualPlayNum&&this.actualPlays>=this.manualPlayNum)this.stop();else{for(0==e&&(this.contexts.forEach((t=>{t.clearRect(0,0,this.width,this.height)})),this.prevF=null,2==s.disposeOp&&(s.disposeOp=1)),this.prevF&&1==this.prevF.disposeOp?this.contexts.forEach((t=>{t.clearRect(this.prevF.left,this.prevF.top,this.prevF.width,this.prevF.height)})):this.prevF&&2==this.prevF.disposeOp&&this.contexts.forEach((t=>{t.putImageData(this.prevF.iData,this.prevF.left,this.prevF.top)})),this.prevF=s,this.prevF.iData=null,2==this.prevF.disposeOp&&(this.prevF.iData=this.contexts[0].getImageData(s.left,s.top,s.width,s.height)),0==s.blendOp&&this.contexts.forEach((t=>{t.clearRect(s.left,s.top,s.width,s.height)})),this.contexts.forEach((t=>{null==this.beforeHook&&null==this.afterHook||t.clearRect(0,0,this.width,this.height),this.beforeHook&&this.beforeHook(t,e),t.drawImage(s.img,s.left,s.top),this.afterHook&&this.afterHook(t,e)})),0==this.nextRenderTime&&(this.nextRenderTime=t);t>this.nextRenderTime+this.playTime;)this.nextRenderTime+=this.playTime;this.nextRenderTime+=s.delay/this.rate}}}let e=new Uint32Array(256);for(var s=0;s<256;s++){for(var a=s,i=0;i<8;i++)a=1&a?3988292384^a>>>1:a>>>1;e[s]=a}const r=new Uint8Array([137,80,78,71,13,10,26,10]);var h=new class extends class{loadUrl(t){return new Promise(((e,s)=>{const a=new XMLHttpRequest;a.open("GET",t),a.responseType="arraybuffer",a.onload=function(){200==this.status?e(this.response):s(this)},a.send()}))}}{constructor(){super(...arguments),this.urlBuffer={},this.url2Promise={}}async urlParse(t,e=!1){return void 0===this.urlBuffer[t]&&(this.urlBuffer[t]=this.loadUrl(t),this.url2Promise[t]=this.urlBuffer[t].then((t=>this.parse(t.slice(0))))),e?this.urlBuffer[t].then((t=>this.parse(t.slice(0)))):this.url2Promise[t]}checkPngSignature(t){for(let e=0;e<r.length;e++)if(r[e]!=t[e])return!1;return!0}createImages(t,e,s,a,i,h){let n=0,o=new Blob(s),l=new Blob(a);for(let s=0;s<t.frames.length;s++){let a=t.frames[s],u=[];u.push(r),e.set(this.makeDWordArray(a.width),0),e.set(this.makeDWordArray(a.height),4),u.push(this.makeChunkBytes("IHDR",e)),u.push(o);for(let t=0;t<a.dataParts.length;t++)u.push(this.makeChunkBytes("IDAT",a.dataParts[t]));u.push(l);let d=URL.createObjectURL(new Blob(u,{type:"image/png"}));delete a.dataParts,u=null,a.img=document.createElement("img"),a.img.onload=function(){URL.revokeObjectURL(this.src),n++,n==t.frames.length&&i(t)},a.img.onerror=function(){h("Image creation error")},a.img.src=d}}parse(t){let e=new Uint8Array(t);return console.log(e),new Promise(((t,s)=>{this.checkPngSignature(e)||(console.error("Not a PNG file (invalid file signature)"),s("Not a PNG file (invalid file signature)"));let{preDataParts:a,postDataParts:i,headerDataBytes:r,anim:h}=this.parseChunks(e);if(0==h.frames.length)return console.error("Not an animated PNG"),void s("Not an animated PNG");this.createImages(h,r,a,i,(e=>{t(e)}),(t=>{console.error(t),s(t)}))}))}parseChunks(e){let s,a,i=[],r=[],h=null,n=null,o=new t,l=8;do{switch(s=this.readDWord(e,l),a=this.readString(e,l+4,4),a){case"IHDR":h=e.subarray(l+8,l+8+s),o.width=this.readDWord(e,l+8),o.height=this.readDWord(e,l+12);break;case"acTL":o.numPlays=this.readDWord(e,l+8+4);break;case"fcTL":n&&o.frames.push(n),n={},n.width=this.readDWord(e,l+8+4),n.height=this.readDWord(e,l+8+8),n.left=this.readDWord(e,l+8+12),n.top=this.readDWord(e,l+8+16);let t=this.readWord(e,l+8+20),a=this.readWord(e,l+8+22);0==a&&(a=100),n.delay=1e3*t/a,n.delay<=10&&(n.delay=100),o.playTime+=n.delay,n.disposeOp=this.readByte(e,l+8+24),n.blendOp=this.readByte(e,l+8+25),n.dataParts=[];break;case"fdAT":n&&n.dataParts.push(e.subarray(l+8+4,l+8+s));break;case"IDAT":n&&n.dataParts.push(e.subarray(l+8,l+8+s));break;case"IEND":r.push(this.subBuffer(e,l,12+s));break;default:i.push(this.subBuffer(e,l,12+s))}l+=12+s}while("IEND"!=a&&l<e.length);return n&&o.frames.push(n),{preDataParts:i,postDataParts:r,headerDataBytes:h,frame:n,anim:o}}readWord(t,e){let s=0;for(let a=0;a<2;a++)s+=t[a+e]<<8*(1-a);return s}readDWord(t,e){let s=0;s+=t[0+e]<<24>>>0;for(let a=1;a<4;a++)s+=t[a+e]<<8*(3-a);return s}readByte(t,e){return t[e]}subBuffer(t,e,s){let a=new Uint8Array(s);return a.set(t.subarray(e,e+s)),a}readString(t,e,s){let a=Array.prototype.slice.call(t.subarray(e,e+s));return String.fromCharCode.apply(String,a)}makeDWordArray(t){return[t>>>24&255,t>>>16&255,t>>>8&255,255&t]}makeStringArray(t){let e=[];for(let s=0;s<t.length;s++)e.push(t.charCodeAt(s));return e}makeChunkBytes(t,s){let a=t.length+s.length,i=new Uint8Array(new ArrayBuffer(a+8));i.set(this.makeDWordArray(s.length),0),i.set(this.makeStringArray(t),4),i.set(s,8);let r=function(t,s,a){for(var i=-1,r=s=s||0,h=s+(a=a||t.length-s);r<h;r++)i=i>>>8^e[255&(i^t[r])];return-1^i}(i,4,a);return i.set(this.makeDWordArray(r),a+4),i}};class n{constructor(){}checkNativeFeatures(){return new Promise((t=>{let e=document.createElement("canvas"),s={TypedArrays:"ArrayBuffer"in global,BlobURLs:"URL"in global,requestAnimationFrame:"requestAnimationFrame"in global,pageProtocol:"http:"==location.protocol||"https:"==location.protocol,canvas:"getContext"in document.createElement("canvas"),APNG:!1};if(s.canvas){let a=new Image;a.onload=function(){let i=e.getContext("2d");i.drawImage(a,0,0),s.APNG=0===i.getImageData(0,0,1,1).data[3],t(s)},a.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAACGFjVEwAAAABAAAAAcMq2TYAAAANSURBVAiZY2BgYPgPAAEEAQB9ssjfAAAAGmZjVEwAAAAAAAAAAQAAAAEAAAAAAAAAAAD6A+gBAbNU+2sAAAARZmRBVAAAAAEImWNgYGBgAAAABQAB6MzFdgAAAABJRU5ErkJggg=="}else t(s)}))}isSupport(t){return void 0===t&&(t=!1),this.checkNativeFeatures().then((e=>e.APNG&&!t?Promise.reject(!1):Promise.resolve(!0)))}parseBuffer(t){return h.parse(t)}parseURL(t,e){return h.urlParse(t,e)}animateImage(t,e,s=!1){e=null==e||e,t.setAttribute("data-is-apng","progress");return(()=>new Promise(((a,i)=>{this.parseURL(t.src,s).then((s=>{(s=>{t.setAttribute("data-is-apng","yes"),"0"===t.style.opacity&&(t.style.opacity="1");let a=document.createElement("canvas");a.width=s.width,a.height=s.height,Array.prototype.slice.call(t.attributes).forEach((function(t){-1==["alt","src","usemap","ismap","data-is-apng","width","height"].indexOf(t.nodeName)&&a.setAttributeNode(t.cloneNode(!1))})),a.setAttribute("data-apng-src",t.src),""!=t.alt&&a.appendChild(document.createTextNode(t.alt));let i="",r="",h=0,n="";""!=t.style.width&&"auto"!=t.style.width?i=t.style.width:t.hasAttribute("width")&&(i=t.getAttribute("width")+"px"),""!=t.style.height&&"auto"!=t.style.height?r=t.style.height:t.hasAttribute("height")&&(r=t.getAttribute("height")+"px"),""!=i&&""==r&&(h=parseFloat(i),n=i.match(/\D+$/)[0],r=Math.round(a.height*h/a.width)+n),""!=r&&""==i&&(h=parseFloat(r),n=r.match(/\D+$/)[0],i=Math.round(a.width*h/a.height)+n),a.style.width=i,a.style.height=r,t.parentNode.insertBefore(a,t),t.style.display="none",s.addContext(a.getContext("2d")),!0===e&&s.play()})(s),a(s)})).catch((e=>{t.setAttribute("data-is-apng","no"),i(e)}))})))()}bindCanvas(t,e){}ifHasCache(t){return new Promise(((e,s)=>{this.emit("getCache",t),this.on("getCacheBack",(t=>{null==t?s(!1):e(t)}))}))}static install(t){t.register("APNG",(()=>{let e=new n;return e.on=t.on,e.emit=t.emit,e.canYouUseCache=t.plugins.LocalCache&&t.plugins.LocalCache.installed,e}))}}n.installed=!1,n.pluginName="APNG",window.APNG=n}();
